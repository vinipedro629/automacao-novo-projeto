<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Upload e Mapeamento de Planilha</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .dashboard-row {
        display: flex;
        flex-wrap: wrap;
        gap: 40px;
        justify-content: center;
      }
      .dashboard-row canvas {
        box-shadow: 0 0 8px #ccd;
        border-radius: 12px;
        background: #fff;
        margin: 12px 0;
        width: 100%;
        max-width: 340px;
        height: 260px;
        min-width: 220px;
      }
      /* tabelas pandas responsivas e alinhadas */
      .table th,
      .table td {
        text-align: center;
        vertical-align: middle !important;
        white-space: nowrap;
        min-width: 110px;
      }
      .table th {
        font-size: 1.09em;
        background: #f8f9fa;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h2 class="mb-4 text-center">Upload e Mapeamento de Planilha</h2>
      {% with messages = get_flashed_messages() %} {% if messages %}
      <div class="alert alert-info">
        {% for message in messages %}
        <div>{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %} {% if not mapping_needed and not selecao_parcial
      and not pronto_automacao %}
      <form
        method="post"
        enctype="multipart/form-data"
        id="uploadForm"
        class="card p-4 shadow-sm mb-4"
      >
        <div class="mb-3">
          <label for="fileElem" class="form-label"
            >Selecione um arquivo Excel/CSV/TXT</label
          >
          <input
            type="file"
            class="form-control"
            name="file"
            id="fileElem"
            accept=".xlsx,.csv,.txt"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary">
          Enviar e Visualizar
        </button>
      </form>
      {% endif %} {% if columns and mapping_needed %}
      <div class="card p-4 shadow-sm mb-4">
        <h5 class="mb-3">
          Selecione e (opcionalmente) renomeie as colunas do seu arquivo:
        </h5>
        <form method="post">
          <input type="hidden" name="mapping" value="ok" />
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Coluna</th>
                <th>Selecionar</th>
                <th>Renomear (opcional)</th>
              </tr>
            </thead>
            <tbody>
              {% for col in columns %}
              <tr>
                <td>{{ col }}</td>
                <td class="text-center">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    name="colunas_selecionadas"
                    value="{{ col }}"
                    checked
                  />
                </td>
                <td>
                  <input
                    class="form-control"
                    type="text"
                    name="novo_nome_{{ col }}"
                    placeholder="Novo nome (opcional)"
                  />
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <button type="submit" class="btn btn-success mt-2">
            Salvar Seleção
          </button>
        </form>
      </div>
      {% endif %} {% if selecao_parcial %}
      <div class="card p-4 shadow-sm mb-4">
        <h5 class="mb-3">Selecione as linhas que deseja automatizar:</h5>
        <form method="post">
          <input type="hidden" name="filtrar_e_processar" value="1" />
          <table class="table table-striped table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Selecionar</th>
                {% for c in columns %}
                <th>{{ c }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in dados %}
              <tr>
                <td class="text-center">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    name="selected"
                    value="{{ loop.index0 }}"
                    checked
                  />
                </td>
                {% for c in columns %}
                <td>{{ row[c] }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <button type="submit" class="btn btn-success mt-2">
            Automatizar Selecionados
          </button>
        </form>
      </div>
      {% endif %} {% if preview %}
      <div class="card p-4 shadow-sm mb-4">
        <h5 class="mb-3">Preview dos Dados Selecionados:</h5>
        <div class="table-responsive">{{ preview|safe }}</div>
      </div>
      {% endif %} {% if pronto_automacao %}
      <div class="card p-4 shadow-sm mb-4">
        <button onclick="iniciarAutomacao()" class="btn btn-danger mb-3">
          Iniciar Automação
        </button>
        <div id="progress-bar-wrap" style="display: none">
          <label>Progresso:</label>
          <div class="progress mb-2">
            <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
          </div>
          <span id="progress-info"></span>
        </div>
        <div id="logs" class="mb-3"></div>
        <div id="relatorio-link" class="mb-3"></div>
        <div id="dashboard" style="display: none">
          <h3 class="text-center">Dashboard</h3>
          <div class="dashboard-row" id="dashboard-rows"></div>
        </div>
      </div>
      {% endif %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      function iniciarAutomacao() {
        fetch("/start_automacao", { method: "POST" })
          .then((resp) => resp.json())
          .then((data) => {
            document.getElementById("progress-bar-wrap").style.display = "";
            atualizarStatus(data.session_id);
          });
      }
      function atualizarStatus(session_id) {
        fetch("/status_automacao/" + session_id)
          .then((resp) => resp.json())
          .then((status) => {
            if (!status.total) return;
            const pct = (status.current / status.total) * 100;
            document.getElementById("progress-bar").style.width = pct + "%";
            document.getElementById("progress-bar").innerText =
              Math.round(pct) + "%";
            document.getElementById(
              "progress-info"
            ).textContent = `${status.current} de ${status.total}`;
            document.getElementById("logs").innerHTML = status.logs
              .map((l) => `<div>${l}</div>`)
              .join("");
            if (status.done && status.relatorio_path) {
              document.getElementById(
                "relatorio-link"
              ).innerHTML = `<a href="/download_relatorio/${session_id}" class="btn btn-info" target="_blank">Baixar Relatório CSV</a>`;
              if (status.stats) {
                document.getElementById("dashboard").style.display = "";
                renderDashboard(status.stats);
              }
            }
            if (!status.done)
              setTimeout(() => atualizarStatus(session_id), 1000);
          });
      }
      function renderDashboard(stats) {
        document.getElementById("dashboard-rows").innerHTML = "";
        let statusCanvas = document.createElement("canvas");
        statusCanvas.id = "graficoStatus";
        document.getElementById("dashboard-rows").appendChild(statusCanvas);
        new Chart(statusCanvas.getContext("2d"), {
          type: "doughnut",
          data: {
            labels: ["Sucessos", "Erros"],
            datasets: [
              {
                data: [stats.sucesso, stats.erro],
                backgroundColor: ["#2ab74b", "#e22"],
              },
            ],
          },
          options: {
            plugins: { legend: { display: true, position: "bottom" } },
            cutout: "60%",
            responsive: true,
            maintainAspectRatio: false,
          },
        });
        for (const key in stats) {
          if (key !== "sucesso" && key !== "erro") {
            let header = document.createElement("h5");
            header.innerText = "Frequência: " + key;
            document.getElementById("dashboard-rows").appendChild(header);
            let canvas = document.createElement("canvas");
            document.getElementById("dashboard-rows").appendChild(canvas);
            new Chart(canvas.getContext("2d"), {
              type: "bar",
              data: {
                labels: Object.keys(stats[key]),
                datasets: [
                  {
                    data: Object.values(stats[key]),
                    backgroundColor: "#3399ff",
                  },
                ],
              },
              options: {
                plugins: { legend: { display: false } },
                scales: {
                  x: { ticks: { font: { size: 13 } } },
                  y: {
                    beginAtZero: true,
                    display: true,
                    grid: { display: true },
                  },
                },
                responsive: true,
                maintainAspectRatio: false,
              },
            });
          }
        }
      }
    </script>
  </body>
</html>
